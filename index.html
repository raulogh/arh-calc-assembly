<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>ASM Custom Simulator</title>
    <style>
        :root { --bg: #1e1e1e; --panel: #252526; --accent: #007acc; --text: #d4d4d4; --green: #4ec9b0; }
        body { font-family: 'Consolas', monospace; display: flex; flex-direction: column; height: 100vh; margin: 0; background: var(--bg); color: var(--text); }
        
        .toolbar { background: #333; padding: 10px; display: flex; gap: 10px; border-bottom: 1px solid #444; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .col { flex: 1; display: flex; flex-direction: column; padding: 10px; border-right: 1px solid #444; }
        
        textarea { flex: 1; background: var(--panel); color: #dcdcdc; border: 1px solid #444; padding: 10px; resize: none; font-size: 14px; line-height: 1.5; outline: none; }
        
        #terminal { flex: 1; background: #111; padding: 10px; overflow-y: auto; font-size: 12px; border: 1px solid #444; margin-top: 10px; }
        .log-line { border-bottom: 1px solid #222; padding: 2px 0; color: #888; }
        .log-curr { color: var(--green); font-weight: bold; }
        .log-err { color: #f44336; }

        .reg-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 5px; background: #333; padding: 10px; margin-bottom: 10px; }
        .reg-box { background: #444; padding: 5px; text-align: center; font-size: 13px; border-radius: 3px; }
        .reg-name { color: var(--accent); font-weight: bold; }

        button { padding: 8px 15px; border: none; background: var(--accent); color: white; cursor: pointer; font-weight: bold; }
        button.red { background: #a31515; }
        button:hover { opacity: 0.9; }
    </style>
</head>
<body>

<div class="toolbar">
    <button onclick="runProgram()">▶ Execută Codul</button>
    <button onclick="stepProgram()">➡ Pas cu Pas</button>
    <button onclick="resetSystem()" class="red">✖ Reset (Curăță Tot)</button>
</div>

<div class="main-container">
    <div class="col">
        <h3>EDITOR</h3>
        <textarea id="codeEditor" spellcheck="false">
MOV BP, #5H
MOV R1, 0H
LOOP:
    SUB R2, R1, #10
    JZ DONE
    LOAD R3, BP
    ADD R4, R3, R3
    STORE BP, R4
    INC R2
    INC BP
    JUMP LOOP
DONE:
        </textarea>
    </div>

    <div class="col">
        <h3>REGISTRE & MEMORIE</h3>
        <div class="reg-grid" id="regs"></div>
        <h3>CONSOLA (Trace Execuție)</h3>
        <div id="terminal"></div>
    </div>
</div>

<script>
    let CPU = {
        PC: 0, Z: 0, BP: 0,
        R: {}, // Registre dinamice R1, R2, etc.
        memory: {},
        labels: {}
    };
    
    // Inițializare memorie cu ceva date ca să aibă LOAD ce să citească
    function initMemory() {
        CPU.memory[5] = 10;
        CPU.memory[6] = 20;
        CPU.memory[7] = 30;
    }

    function log(msg, type='') {
        const t = document.getElementById('terminal');
        t.innerHTML += `<div class="log-line ${type}">${msg}</div>`;
        t.scrollTop = t.scrollHeight;
    }

    function updateUI() {
        let html = `
            <div class="reg-box"><span class="reg-name">PC</span> ${CPU.PC}</div>
            <div class="reg-box"><span class="reg-name">BP</span> ${CPU.BP}</div>
            <div class="reg-box"><span class="reg-name">Z-Flag</span> ${CPU.Z}</div>
        `;
        // Afisare registre R...
        Object.keys(CPU.R).sort().forEach(k => {
            html += `<div class="reg-box"><span class="reg-name">${k}</span> ${CPU.R[k]}</div>`;
        });
        
        // Afisare Memorie (doar ce e folosit)
        Object.keys(CPU.memory).forEach(addr => {
             html += `<div class="reg-box" style="border:1px solid #555"><span class="reg-name">MEM[${addr}]</span> ${CPU.memory[addr]}</div>`;
        });

        document.getElementById('regs').innerHTML = html;
    }

    function resetSystem() {
        CPU = { PC: 0, Z: 0, BP: 0, R: {}, memory: {}, labels: {} };
        initMemory(); // Repopulam memoria
        document.getElementById('terminal').innerHTML = "";
        log("Sistem resetat. Memoria la adresa 5,6,7 a fost inițializată cu 10,20,30.");
        updateUI();
    }

    // --- PARSER ---
    function parseVal(op) {
        if(!op) return 0;
        op = op.trim().toUpperCase();
        if(op.includes('#')) return parseInt(op.replace('#','').replace('H',''), 16); // Hex supports #10H
        if(op.endsWith('H')) return parseInt(op.replace('H',''), 16); // Hex supports 10H
        if(op === 'BP') return CPU.BP;
        if(CPU.R[op] !== undefined) return CPU.R[op]; // E registru existent
        if(op.startsWith('R')) return 0; // Registru nou, valoare default 0
        if(!isNaN(parseInt(op))) return parseInt(op); // Numar simplu
        return 0;
    }

    function setVal(op, val) {
        op = op.trim().toUpperCase();
        if(op === 'BP') CPU.BP = val;
        else CPU.R[op] = val;
    }

    function executeLine(rawLine) {
        // Curatare tab-uri si spatii duble
        let line = rawLine.replace(/\t/g, ' ').trim();
        if(!line || line.endsWith(':')) return true;

        // Logging executie
        log(`[L${CPU.PC+1}] Execut: <span class="log-curr">${line}</span>`);

        // Parsare argumente (split la virgula sau spatiu)
        let parts = line.replace(/,/g, ' ').split(/\s+/);
        let cmd = parts[0].toUpperCase();
        let args = parts.slice(1);

        try {
            switch(cmd) {
                case 'MOV': 
                    setVal(args[0], parseVal(args[1])); 
                    break;
                
                case 'SUB': 
                    // Sintaxa 3 args: SUB R2, R1, #10 -> R2 = R1 - 10
                    if(args.length === 3) {
                        let res = parseVal(args[1]) - parseVal(args[2]);
                        setVal(args[0], res);
                        CPU.Z = (res === 0) ? 1 : 0;
                    } else {
                        // Sintaxa 2 args
                        let res = parseVal(args[0]) - parseVal(args[1]);
                        setVal(args[0], res);
                        CPU.Z = (res === 0) ? 1 : 0;
                    }
                    break;

                case 'ADD':
                    // Sintaxa 3 args: ADD R4, R3, R3 -> R4 = R3 + R3
                    if(args.length === 3) {
                        let res = parseVal(args[1]) + parseVal(args[2]);
                        setVal(args[0], res);
                    } else {
                        setVal(args[0], parseVal(args[0]) + parseVal(args[1]));
                    }
                    break;

                case 'LOAD': 
                    // LOAD R3, BP -> R3 = Memory[BP]
                    let addrLoad = parseVal(args[1]); // BP val
                    let valLoad = CPU.memory[addrLoad] || 0;
                    setVal(args[0], valLoad);
                    break;

                case 'STORE':
                    // STORE BP, R4 -> Memory[BP] = R4
                    let addrStore = parseVal(args[0]);
                    let valStore = parseVal(args[1]);
                    CPU.memory[addrStore] = valStore;
                    break;

                case 'INC':
                    let v = parseVal(args[0]) + 1;
                    setVal(args[0], v);
                    break;

                case 'JUMP':
                case 'JMP':
                    let lbl = args[0];
                    if(CPU.labels[lbl] !== undefined) CPU.PC = CPU.labels[lbl] - 1;
                    break;

                case 'JZ':
                    if(CPU.Z === 1) CPU.PC = CPU.labels[args[0]] - 1;
                    break;
            }
        } catch(e) {
            log("Eroare: " + e.message, "log-err");
            return false;
        }
        return true;
    }

    function prepareCode() {
        resetSystem();
        const text = document.getElementById('codeEditor').value;
        const lines = text.split('\n');
        
        // Pas 1: Scanare etichete
        lines.forEach((l, i) => {
            let clean = l.trim().replace(/\t/g, '');
            if(clean.endsWith(':')) {
                CPU.labels[clean.slice(0, -1)] = i;
            }
        });
        return lines;
    }

    function runProgram() {
        const lines = prepareCode();
        let steps = 0;
        
        let interval = setInterval(() => {
            if(CPU.PC >= lines.length || steps > 100) { // Limitare la 100 pasi pt siguranta
                clearInterval(interval);
                log("Execuție finalizată (sau limită pași atinsă).");
                return;
            }
            
            executeLine(lines[CPU.PC]);
            CPU.PC++;
            updateUI();
            steps++;
        }, 100); // Executa o linie la 100ms ca sa vezi ce se intampla
    }

    // Initializeaza la pornire
    initMemory();
    updateUI();
</script>
</body>
</html>
